<ion-header class="uniform-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button menu="main-menu"></ion-menu-button>
      <ion-back-button [defaultHref]="'/maintenance/insurance/list/' + maintenanceId"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ 'insurance_add_title' | translate }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="saveInsuranceDetail()" [disabled]="!insuranceDetailForm.valid || loading || loadingCatalogs" fill="solid" color="primary">
        @if (!loading) {
          <ion-icon name="checkmark" slot="start"></ion-icon>
        }
        {{ loading ? ('insurance_add_saving' | translate) : ('insurance_actions_save' | translate) }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="modern-form-content">
  <div class="form-container">
    
    <!-- Loading Catalogs Indicator -->
    @if (loadingCatalogs) {
      <div class="loading-overlay">
        <div class="loading-content">
          <ion-spinner name="crescent"></ion-spinner>
          <p>{{ 'insurance_add_loadingCatalogs' | translate }}</p>
        </div>
      </div>
    }

    @if (!loadingCatalogs) {
      <form [formGroup]="insuranceDetailForm" (ngSubmit)="saveInsuranceDetail()">
        
        <!-- Header Section -->
        <div class="form-header">
          <ion-icon name="shield-checkmark" class="header-icon"></ion-icon>
          <h2>{{ 'insurance_add_header_title' | translate }}</h2>
          <p>{{ 'insurance_add_header_subtitle' | translate }}</p>
        </div>

        <!-- Form Fields -->
        <div class="form-fields">
          
          <!-- Policy Number Field -->
          <div class="field-group">
            <label class="field-label">{{ 'insurance_form_policyNumber_label' | translate }} *</label>
            <ion-input 
              formControlName="policyNumber" 
              [placeholder]="'insurance_form_policyNumber_placeholder' | translate"
              class="modern-input"
              fill="outline">
            </ion-input>
            @if (insuranceDetailForm.get('policyNumber')?.invalid && insuranceDetailForm.get('policyNumber')?.touched) {
              <div class="error-message">
                {{ getFieldError('policyNumber') }}
              </div>
            }
          </div>

          <!-- Insurance Amount Field -->
          <div class="field-group">
            <label class="field-label">{{ 'amount' | translate }} *</label>
            <ion-input 
              formControlName="amount" 
              type="number"
              step="0.01"
              min="0.01"
              [placeholder]="'amount' | translate"
              class="modern-input"
              fill="outline">
            </ion-input>
            @if (insuranceDetailForm.get('amount')?.invalid && insuranceDetailForm.get('amount')?.touched) {
              <div class="error-message">
                {{ getFieldError('amount') }}
              </div>
            }
          </div>

          <!-- Currency Field -->
          <div class="field-group">
            <label class="field-label">{{ 'insurance_form_currency_label' | translate }} *</label>
            <ion-select 
              formControlName="currency" 
              [placeholder]="'insurance_form_currency_placeholder' | translate" 
              class="modern-select"
              fill="outline">
              @for (currency of currencies; track currency.id) {
                <ion-select-option [value]="currency.code">
                  {{ currency.name }} ({{ currency.code }})
                </ion-select-option>
              }
            </ion-select>
            @if (insuranceDetailForm.get('currency')?.invalid && insuranceDetailForm.get('currency')?.touched) {
              <div class="error-message">
                {{ getFieldError('currency') }}
              </div>
            }
          </div>

        

          <!-- Coverage Start Date Field -->
          <div class="field-group">
            <label class="field-label">{{ 'insurance_form_coverageStartDate_label' | translate }}</label>
            <ion-input 
              formControlName="coverageStartDate" 
              type="date"
              class="modern-input"
              fill="outline">
            </ion-input>
            @if (insuranceDetailForm.get('coverageStartDate')?.invalid && insuranceDetailForm.get('coverageStartDate')?.touched) {
              <div class="error-message">
                {{ getFieldError('coverageStartDate') }}
              </div>
            }
          </div>

          <!-- Coverage End Date Field -->
          <div class="field-group">
            <label class="field-label">{{ 'insurance_form_coverageEndDate_label' | translate }}</label>
            <ion-input 
              formControlName="coverageEndDate" 
              type="date"
              class="modern-input"
              fill="outline">
            </ion-input>
            @if (insuranceDetailForm.get('coverageEndDate')?.invalid && insuranceDetailForm.get('coverageEndDate')?.touched) {
              <div class="error-message">
                {{ getFieldError('coverageEndDate') }}
              </div>
            }
          </div>

          <!-- Coverage Duration Display -->
          @if (calculateCoverageDuration() > 0) {
            <div class="field-group">
              <label class="field-label">{{ 'insurance_form_coverageDuration_label' | translate }}</label>
              <div class="duration-display">
                <ion-icon name="calendar"></ion-icon>
                <span class="duration-amount">{{ calculateCoverageDuration() }} {{ 'insurance_form_coverageDuration_days' | translate }}</span>
              </div>
            </div>
          }

          <!-- Total Coverage Display -->
          @if (insuranceDetailForm.get('amount')?.value && insuranceDetailForm.get('currency')?.value) {
            <div class="field-group">
              <label class="field-label">{{ 'insurance_form_totalCoverage_label' | translate }}</label>
              <div class="coverage-display">
                <ion-icon name="shield-checkmark"></ion-icon>
                <span class="coverage-amount">{{ formatCurrencyDisplay(insuranceDetailForm.get('amount')?.value, insuranceDetailForm.get('currency')?.value) }}</span>
              </div>
            </div>
          }

        </div>

      </form>
    }

    <!-- Loading Spinner for Save -->
    @if (loading) {
      <div class="loading-overlay">
        <div class="loading-content">
          <ion-spinner name="crescent"></ion-spinner>
          <p>{{ 'insurance_add_saving' | translate }}</p>
        </div>
      </div>
    }
  </div>
</ion-content>

<!-- âœ… FOOTER CON APP-FOOTER -->
<app-footer
  [showSaveButton]="true"
  [saveButtonText]="'insurance.actions.save'"
  [saveButtonDisabled]="!insuranceDetailForm.valid || loadingCatalogs"
  [saveButtonLoading]="loading"
  (onSave)="saveInsuranceDetail()"
  (onBack)="cancelForm()">
</app-footer>
