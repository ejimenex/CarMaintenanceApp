<ion-header class="uniform-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button menu="main-menu"></ion-menu-button>
      <ion-back-button defaultHref="/maintenance"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ 'maintenance_edit_title' | translate }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="updateMaintenance()" [disabled]="!maintenanceForm.valid || loading || loadingData" fill="solid" color="primary">
        @if (!loading) {
          <ion-icon name="checkmark" slot="start"></ion-icon>
        }
        {{ loading ? ('maintenance_edit_saving' | translate) : ('maintenance_actions_save' | translate) }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="modern-form-content">
  <div class="form-container">
    
    <!-- Loading Data Indicator -->
    @if (loadingData) {
      <div class="loading-overlay">
        <div class="loading-content">
          <ion-spinner name="crescent"></ion-spinner>
          <p>{{ 'maintenance_edit_loadingData' | translate }}</p>
        </div>
      </div>
    }

    @if (!loadingData) {
      <form [formGroup]="maintenanceForm" (ngSubmit)="updateMaintenance()">
        
        <!-- Header Section -->
        <div class="form-header">
          <ion-icon name="create" class="header-icon"></ion-icon>
          <h2>{{ 'maintenance_edit_header_title' | translate }}</h2>
          <p>{{ 'maintenance_edit_header_subtitle' | translate }}</p>
        </div>

        <!-- Form Fields -->
        <div class="form-fields">
          
          <!-- Name Field -->
          <div class="field-group">
            <label class="field-label">{{ 'maintenance_form_name_label' | translate }} *</label>
            <ion-input 
              formControlName="name" 
              [placeholder]="'maintenance_form_name_placeholder' | translate"
              class="modern-input"
              fill="outline">
            </ion-input>
            @if (maintenanceForm.get('name')?.invalid && maintenanceForm.get('name')?.touched) {
              <div class="error-message">
                {{ getFieldError('name') }}
              </div>
            }
          </div>

          <!-- Vehicle Selection -->
          <div class="field-group">
            <label class="field-label">{{ 'maintenance_form_vehicle_label' | translate }} *</label>
            <ion-select 
              formControlName="vehicleId" 
              [placeholder]="'maintenance_form_vehicle_placeholder' | translate" 
              class="modern-select"
              fill="outline">
              @for (vehicle of vehicles; track vehicle.value) {
                <ion-select-option [value]="vehicle.value">
                  {{ vehicle.label }}
                </ion-select-option>
              }
            </ion-select>
            @if (maintenanceForm.get('vehicleId')?.invalid && maintenanceForm.get('vehicleId')?.touched) {
              <div class="error-message">
                {{ getFieldError('vehicleId') }}
              </div>
            }
          </div>

          <!-- Trade/Workshop Selection -->
          <div class="field-group">
            <label class="field-label">{{ 'maintenance_form_workshop_label' | translate }} *</label>
            <ion-select 
              formControlName="tradeId" 
              [placeholder]="'maintenance_form_workshop_placeholder' | translate" 
              class="modern-select"
              fill="outline">
              @for (workshop of workshops; track workshop.value) {
                <ion-select-option [value]="workshop.value">
                  {{ workshop.label }}
                </ion-select-option>
              }
            </ion-select>
            @if (maintenanceForm.get('tradeId')?.invalid && maintenanceForm.get('tradeId')?.touched) {
              <div class="error-message">
                {{ getFieldError('tradeId') }}
              </div>
            }
          </div>

          <!-- Process Type Field -->
          <div class="field-group">
            <label class="field-label">{{ 'maintenance_form_processType_label' | translate }} *</label>
            <ion-select 
              formControlName="processType" 
              [placeholder]="'maintenance_form_processType_placeholder' | translate" 
              class="modern-select"
              fill="outline">
              @for (type of processTypes; track type.value) {
                <ion-select-option [value]="type.value">
                  {{ ('maintenance.form.processType.options.' + type.value) | translate }}
                </ion-select-option>
              }
            </ion-select>
            @if (maintenanceForm.get('processType')?.invalid && maintenanceForm.get('processType')?.touched) {
              <div class="error-message">
                {{ getFieldError('processType') }}
              </div>
            }
          </div>

          <!-- Start Date Field -->
          <div class="field-group">
            <label class="field-label">{{ 'maintenance_form_startDate_label' | translate }}</label>
            <ion-input 
              formControlName="startDate" 
              type="date"
              class="modern-input"
              fill="outline">
            </ion-input>
            @if (maintenanceForm.get('startDate')?.invalid && maintenanceForm.get('startDate')?.touched) {
              <div class="error-message">
                {{ getFieldError('startDate') }}
              </div>
            }
          </div>

          <!-- End Date Field -->
          <div class="field-group">
            <label class="field-label">{{ 'maintenance_form_endDate_label' | translate }}</label>
            <ion-input 
              formControlName="endDate" 
              type="date"
              class="modern-input"
              fill="outline">
            </ion-input>
            @if (maintenanceForm.get('endDate')?.invalid && maintenanceForm.get('endDate')?.touched) {
              <div class="error-message">
                {{ getFieldError('endDate') }}
              </div>
            }
          </div>

          <!-- note Field -->
          <div class="field-group">
            <label class="field-label">{{ 'maintenance_form_note_label' | translate }}</label>
            <ion-textarea 
              formControlName="note" 
              [placeholder]="'maintenance_form_note_placeholder' | translate"
              rows="3"
              class="modern-input"
              fill="outline">
            </ion-textarea>
            @if (maintenanceForm.get('note')?.invalid && maintenanceForm.get('note')?.touched) {
              <div class="error-message">
                {{ getFieldError('note') }}
              </div>
            }
          </div>

        </div>

      </form>
    }

    <!-- Loading Spinner for Update -->
    @if (loading) {
      <div class="loading-overlay">
        <div class="loading-content">
          <ion-spinner name="crescent"></ion-spinner>
          <p>{{ 'maintenance_edit_saving' | translate }}</p>
        </div>
      </div>
    }
  </div>
</ion-content>

<!-- âœ… FOOTER CON APP-FOOTER -->
<app-footer
  [showSaveButton]="true"
  [saveButtonText]="'maintenance.actions.update'"
  [saveButtonDisabled]="!maintenanceForm.valid || loadingData"
  [saveButtonLoading]="loading"
  [customBackRoute]="'/maintenance'"
  (onSave)="updateMaintenance()"
  (onBack)="cancelForm()">
</app-footer>
