<ion-header class="uniform-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button (click)="onCancel()"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ 'maintenance_detail_add_title' | translate }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="onSubmit()" [disabled]="!maintenanceDetailForm.valid || loading" fill="solid" color="primary">
        <ion-icon name="checkmark" slot="start"></ion-icon>
        {{ 'common_save' | translate }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="modern-form-content">
  <div class="form-container">
    <form [formGroup]="maintenanceDetailForm" (ngSubmit)="onSubmit()">
      
      <!-- Header Section -->
      <div class="form-header">
        <ion-icon name="construct" class="header-icon"></ion-icon>
        <h2>{{ 'maintenance_detail_add_title' | translate }}</h2>
        <p>{{ 'maintenance_detail_add_form_description' | translate }}</p>
      </div>

      <!-- Loading Spinner -->
      <div *ngIf="loading" class="loading-container">
        <ion-spinner name="crescent"></ion-spinner>
        <p>{{ 'common_loading' | translate }}</p>
      </div>

      <!-- Error Message -->
      <div *ngIf="errorMessage && !loading" class="error-container">
        <ion-icon name="alert-circle" color="danger"></ion-icon>
        <p>{{ errorMessage }}</p>
      </div>

      <!-- Form Fields -->
      <div class="form-fields" *ngIf="!loading">
        
        <!-- Name Field -->
        <div class="field-group">
          <label class="field-label">{{ 'maintenance_detail_add_form_name' | translate }} *</label>
          <ion-input 
            formControlName="name" 
            [placeholder]="'maintenance_detail_add_form_name_placeholder' | translate"
            class="modern-input"
            fill="outline">
          </ion-input>
          @if (isFieldInvalid('name')) {
            <div class="error-message">
              {{ getFieldError('name') }}
            </div>
          }
        </div>

        <!-- Description Field -->
        <div class="field-group">
          <label class="field-label">{{ 'maintenance_detail_add_form_descriptionLabel' | translate }}</label>
          <ion-textarea 
            formControlName="description" 
            [placeholder]="'maintenance_detail_add_form_description_placeholder' | translate"
            class="modern-textarea"
            fill="outline"
            rows="3">
          </ion-textarea>
        </div>

        <!-- Diagnosis Field -->
        <div class="field-group">
          <label class="field-label">{{ 'maintenance_detail_add_form_diagnosis' | translate }} *</label>
          <ion-textarea 
            formControlName="diagnosis" 
            [placeholder]="'maintenance_detail_add_form_diagnosis_placeholder' | translate"
            class="modern-textarea"
            fill="outline"
            rows="3">
          </ion-textarea>
          @if (isFieldInvalid('diagnosis')) {
            <div class="error-message">
              {{ getFieldError('diagnosis') }}
            </div>
          }
        </div>

        <!-- Mileage and Cost Row -->
        <div class="row">
          <div class="col-6">
            <div class="field-group">
              <label class="field-label">{{ 'maintenance_detail_add_form_mileage' | translate }} *</label>
              <ion-input 
                formControlName="mileage" 
                type="number"
                [placeholder]="'maintenance_detail_add_form_mileage_placeholder' | translate"
                class="modern-input"
                fill="outline">
              </ion-input>
              @if (isFieldInvalid('mileage')) {
                <div class="error-message">
                  {{ getFieldError('mileage') }}
                </div>
              }
            </div>
          </div>
          <div class="col-6">
            <div class="field-group">
              <label class="field-label">{{ 'maintenance_detail_add_form_cost' | translate }} *</label>
              <ion-input 
                formControlName="cost" 
                type="number"
                step="0.01"
                [placeholder]="'maintenance_detail_add_form_cost_placeholder' | translate"
                class="modern-input"
                fill="outline">
              </ion-input>
              @if (isFieldInvalid('cost')) {
                <div class="error-message">
                  {{ getFieldError('cost') }}
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Technician Field -->
        <div class="field-group">
          <label class="field-label">{{ 'maintenance_detail_add_form_technician' | translate }}</label>
          <ion-input 
            formControlName="Technician" 
            [placeholder]="'maintenance_detail_add_form_technician_placeholder' | translate"
            class="modern-input"
            fill="outline">
          </ion-input>
        </div>

        <!-- Maintenance Type Field -->
        <div class="field-group">
          <label class="field-label">{{ 'maintenance_detail_add_form_maintenanceType' | translate }} *</label>
          <ion-select 
            formControlName="maintenanceTypeId"
            [placeholder]="'maintenance_detail_add_form_maintenanceType_placeholder' | translate"
            class="modern-select"
            fill="outline">
            @for (type of maintenanceTypes; track type.code) {
              <ion-select-option [value]="type.code">
                {{ type.name }}
              </ion-select-option>
            }
          </ion-select>
          @if (isFieldInvalid('maintenanceTypeId')) {
            <div class="error-message">
              {{ getFieldError('maintenanceTypeId') }}
            </div>
          }
        </div>

        <!-- Next Maintenance Date Field -->
        <div class="field-group">
          <label class="field-label">{{ 'maintenance_detail_add_form_nextMaintenanceDate' | translate }}</label>
          <ion-input 
            formControlName="nextMaintenanceDate" 
            type="date"
            class="modern-input"
            fill="outline">
          </ion-input>
        </div>

        <!-- Maintenance Parts & Services Section -->
        <div class="section-card">
          <div class="section-header">
            <label class="field-label">
              <ion-icon name="build" class="field-icon"></ion-icon>
              {{ 'maintenance_parts_title' | translate }}
            </label>
            <div class="header-actions">
              <ion-button 
                (click)="toggleAddPartForm()" 
                fill="solid" 
                color="primary" 
                size="small"
                class="add-part-btn">
                <ion-icon name="add" slot="start"></ion-icon>
                Agregar
              </ion-button>
              <ion-button 
                (click)="openBasicMaintenanceModal()" 
                fill="solid" 
                color="secondary" 
                size="small"
                class="add-basic-maintenance-btn">
                <ion-icon name="checkbox-outline" slot="start"></ion-icon>
                Servicios básicos
              </ion-button>
            </div>
          </div>

          <!-- Basic Maintenances List -->
          @if (basicMaintenancesSelected.length > 0) {
            <div class="basic-maintenances-list">
              <label class="field-label">
                <ion-icon name="checkmark-done-circle" class="label-icon"></ion-icon>
                Servicios seleccionados ({{ basicMaintenancesSelected.length }})
              </label>
              <div class="maintenance-items-grid">
                @for (m of basicMaintenancesSelected; let i = $index; track m.id) {
                  <div class="basic-maintenance-item">
                    <div class="item-content">
                      <ion-icon name="checkmark-circle" class="check-icon"></ion-icon>
                      <span class="item-name">{{ m.name | translate }}</span>
                    </div>
                    <ion-button 
                      fill="clear" 
                      color="danger" 
                      size="small" 
                      class="remove-btn"
                      (click)="removeBasicMaintenance(i)">
                      <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Parts List -->
          @if (maintenanceParts.length > 0) {
            <div class="parts-list">
              <label class="field-label parts-label">
                <ion-icon name="cube" class="label-icon"></ion-icon>
                Repuestos agregados ({{ maintenanceParts.length }})
              </label>
              @for (part of maintenanceParts; track part.id; let i = $index) {
                <div class="part-item">
                  <div class="part-info">
                    <div class="part-name">{{ part.name }}</div>
                    <div class="part-details">
                      <span class="part-quantity">
                        <ion-icon name="layers-outline"></ion-icon>
                        {{ part.quantity }} {{ getUnitOfMeasureName(part.unitOfMeasure) }}
                      </span>
                      <span class="part-cost">
                        <ion-icon name="pricetag-outline"></ion-icon>
                        {{ part.cost | currency:'USD':'symbol':'1.2-2' }} c/u
                      </span>
                      <span class="part-total">
                        <ion-icon name="wallet-outline"></ion-icon>
                        {{ part.totalCost | currency:'USD':'symbol':'1.2-2' }}
                      </span>
                    </div>
                  </div>
                  <ion-button 
                    (click)="removeMaintenancePart(i)" 
                    fill="clear" 
                    color="danger" 
                    size="small"
                    class="remove-part-btn">
                    <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>
              }
            </div>
          }

          <!-- Empty State -->
          @if (maintenanceParts.length === 0 && basicMaintenancesSelected.length === 0) {
            <div class="empty-parts">
              <ion-icon name="construct-outline" class="empty-icon"></ion-icon>
              <p class="empty-title">{{ 'maintenance_parts_empty' | translate }}</p>
              <p class="empty-subtitle">Agrega repuestos o selecciona servicios básicos</p>
            </div>
          }
        </div>

      </div>

    </form>

    <!-- Loading Spinner -->
    @if (loading) {
      <div class="loading-overlay">
        <div class="loading-content">
          <ion-spinner name="crescent"></ion-spinner>
          <p>{{ 'common_loading' | translate }}</p>
        </div>
      </div>
    }
  </div>
</ion-content>

<!-- ✅ FOOTER CON APP-FOOTER -->
<app-footer
  [showSaveButton]="true"
  [saveButtonText]="'common.save'"
  [saveButtonDisabled]="maintenanceDetailForm.invalid"
  [saveButtonLoading]="loading"
  (onSave)="onSubmit()"
  (onBack)="onCancel()">
</app-footer>
